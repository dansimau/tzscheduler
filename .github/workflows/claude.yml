name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npx playwright install --with-deps chromium

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          prompt: |
            Address the issues or feedback from the comment or issue you were tagged in.

            When adding features or fixing bugs, ensure there is a test that covers the new functionality or bug fix. If there are existing flaky tests, always just fix them, even if they are unrelated to your changes.

            Whenever you are done working, always post a comment with a link to preview the latest changes using githack.com and the raw index.html URL based on the last commit. For example, if you URL to the raw index.html is "https://raw.githubusercontent.com/dansimau/tzscheduler/77353183f55b7c1889ac9c0495a96b52202ed278/index.html", the preview URL becomes "https://raw.githack.com/dansimau/tzscheduler/77353183f55b7c1889ac9c0495a96b52202ed278/index.html".

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: |
            --allowed-tools Bash(cat:*)
            --allowed-tools Bash(git fetch origin)
            --allowed-tools Bash(git format-patch)
            --allowed-tools Bash(git pull origin)
            --allowed-tools Bash(git rev-parse)
            --allowed-tools Bash(npm install)
            --allowed-tools Bash(npm test)
            --allowed-tools Bash(npm run test)
            --allowed-tools Bash(npm run serve)
